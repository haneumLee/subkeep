name: CD - Deploy to Production

on:
  push:
    branches:
      - main
    tags:
      - 'v*.*.*'

env:
  GO_VERSION: '1.22'
  NODE_VERSION: '20'

jobs:
  # ==================== Build and Test ====================
  build:
    name: Build & Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
      
      - name: Build backend
        working-directory: ./backend
        run: |
          go mod download
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build \
            -ldflags="-w -s" \
            -o bin/server \
            ./cmd/server
      
      - name: Upload backend artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-binary
          path: backend/bin/server
          retention-days: 1

  # ==================== Deploy to OracleVM ====================
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: production
      url: http://your-production-url.com
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download backend artifact
        uses: actions/download-artifact@v4
        with:
          name: backend-binary
          path: backend/bin/
      
      - name: Make binary executable
        run: chmod +x backend/bin/server
      
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_SSH_KEY }}
      
      - name: Add known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.PRODUCTION_HOST }} >> ~/.ssh/known_hosts
      
      - name: Deploy backend
        env:
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_HOST: ${{ secrets.PRODUCTION_HOST }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          # Upload backend binary
          scp backend/bin/server ${DEPLOY_USER}@${DEPLOY_HOST}:${DEPLOY_PATH}/backend/bin/
          
          # Upload ecosystem config
          scp ecosystem.config.js ${DEPLOY_USER}@${DEPLOY_HOST}:${DEPLOY_PATH}/
          
          # Restart with PM2
          ssh ${DEPLOY_USER}@${DEPLOY_HOST} << 'ENDSSH'
            cd ${{ secrets.DEPLOY_PATH }}
            pm2 reload ecosystem.config.js --env production
            pm2 save
          ENDSSH
      
      - name: Run database migrations
        env:
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_HOST: ${{ secrets.PRODUCTION_HOST }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
          DB_URL: ${{ secrets.DATABASE_URL }}
        run: |
          ssh ${DEPLOY_USER}@${DEPLOY_HOST} << 'ENDSSH'
            cd ${{ secrets.DEPLOY_PATH }}/backend
            ./scripts/migrate.sh up
          ENDSSH
      
      - name: Health check
        run: |
          sleep 10
          curl -f http://${{ secrets.PRODUCTION_HOST }}:8080/health || exit 1
      
      - name: Notify deployment success
        if: success()
        run: |
          echo "✅ Deployment to production successful!"
      
      - name: Rollback on failure
        if: failure()
        env:
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_HOST: ${{ secrets.PRODUCTION_HOST }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          echo "❌ Deployment failed, rolling back..."
          ssh ${DEPLOY_USER}@${DEPLOY_HOST} << 'ENDSSH'
            cd ${{ secrets.DEPLOY_PATH }}
            pm2 reload ecosystem.config.js --env production
          ENDSSH

  # ==================== Create GitHub Release ====================
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: deploy
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Create Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          release_name: Release ${{ github.ref_name }}
          body: |
            ## Changes in this Release
            
            See [CHANGELOG.md](CHANGELOG.md) for details.
            
            ## Deployment
            - ✅ Deployed to production OracleVM
            - ✅ Database migrations applied
            - ✅ Health checks passed
          draft: false
          prerelease: false
