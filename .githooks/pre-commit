#!/bin/bash
# ====================================
# SubKeep Pre-Commit Hook
# ====================================
# This script runs before each commit to ensure code quality
#
# Installation:
#   chmod +x .githooks/pre-commit
#   git config core.hooksPath .githooks

set -e

echo "üîç Running pre-commit checks..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Track overall status
FAILED=0

# ==================== Backend Checks ====================
if [ -d "backend" ]; then
  echo ""
  echo "üì¶ Checking Go backend..."
  
  cd backend
  
  # Check if Go files were modified
  GO_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.go$' || true)
  
  if [ -n "$GO_FILES" ]; then
    # Run go fmt
    echo "  ‚úì Running gofmt..."
    if ! gofmt -l $GO_FILES | grep -q .; then
      echo -e "    ${GREEN}‚úì Go formatting OK${NC}"
    else
      echo -e "    ${RED}‚úó Go files need formatting${NC}"
      gofmt -l $GO_FILES
      echo -e "    ${YELLOW}Run: gofmt -w .${NC}"
      FAILED=1
    fi
    
    # Run go vet
    echo "  ‚úì Running go vet..."
    if go vet ./...; then
      echo -e "    ${GREEN}‚úì Go vet OK${NC}"
    else
      echo -e "    ${RED}‚úó Go vet failed${NC}"
      FAILED=1
    fi
    
    # Run golangci-lint (if installed)
    if command -v golangci-lint &> /dev/null; then
      echo "  ‚úì Running golangci-lint..."
      if golangci-lint run --timeout 5m; then
        echo -e "    ${GREEN}‚úì Linting OK${NC}"
      else
        echo -e "    ${RED}‚úó Linting failed${NC}"
        FAILED=1
      fi
    else
      echo -e "    ${YELLOW}‚ö† golangci-lint not installed, skipping${NC}"
    fi
    
    # Run tests
    echo "  ‚úì Running Go tests..."
    if go test -race -short ./...; then
      echo -e "    ${GREEN}‚úì Tests passed${NC}"
    else
      echo -e "    ${RED}‚úó Tests failed${NC}"
      FAILED=1
    fi
  else
    echo "  ‚äò No Go files changed, skipping checks"
  fi
  
  cd ..
fi

# ==================== Frontend Checks ====================
if [ -d "frontend" ]; then
  echo ""
  echo "üé® Checking frontend..."
  
  cd frontend
  
  # Check if TS/TSX/JS/JSX files were modified
  FRONTEND_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|js|jsx)$' || true)
  
  if [ -n "$FRONTEND_FILES" ]; then
    # Check if node_modules exists
    if [ ! -d "node_modules" ]; then
      echo -e "    ${YELLOW}‚ö† node_modules not found, skipping frontend checks${NC}"
      echo -e "    ${YELLOW}Run: npm install${NC}"
    else
      # Run ESLint
      echo "  ‚úì Running ESLint..."
      if npm run lint --silent; then
        echo -e "    ${GREEN}‚úì ESLint OK${NC}"
      else
        echo -e "    ${RED}‚úó ESLint failed${NC}"
        FAILED=1
      fi
      
      # Run Prettier check
      if command -v prettier &> /dev/null || [ -f "node_modules/.bin/prettier" ]; then
        echo "  ‚úì Checking Prettier formatting..."
        if npx prettier --check $FRONTEND_FILES; then
          echo -e "    ${GREEN}‚úì Formatting OK${NC}"
        else
          echo -e "    ${RED}‚úó Files need formatting${NC}"
          echo -e "    ${YELLOW}Run: npm run format${NC}"
          FAILED=1
        fi
      fi
      
      # Type check
      echo "  ‚úì Running TypeScript type check..."
      if npm run type-check --silent 2>/dev/null || npx tsc --noEmit; then
        echo -e "    ${GREEN}‚úì Type check OK${NC}"
      else
        echo -e "    ${RED}‚úó Type check failed${NC}"
        FAILED=1
      fi
    fi
  else
    echo "  ‚äò No frontend files changed, skipping checks"
  fi
  
  cd ..
fi

# ==================== Commit Message Check ====================
echo ""
echo "üìù Validating commit message format..."

COMMIT_MSG_FILE=$1
if [ -f "$COMMIT_MSG_FILE" ]; then
  COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")
  
  # Check for Conventional Commits format
  if echo "$COMMIT_MSG" | grep -qE '^(feat|fix|docs|style|refactor|perf|test|chore|build|ci|revert)(\(.+\))?: .{3,}'; then
    echo -e "  ${GREEN}‚úì Commit message format OK${NC}"
  else
    echo -e "  ${RED}‚úó Invalid commit message format${NC}"
    echo ""
    echo "Commit message should follow Conventional Commits:"
    echo "  <type>(<scope>): <subject>"
    echo ""
    echo "Types: feat, fix, docs, style, refactor, perf, test, chore, build, ci, revert"
    echo ""
    echo "Examples:"
    echo "  feat(api): add user authentication endpoint"
    echo "  fix(ui): resolve button alignment issue"
    echo "  docs: update installation guide"
    echo ""
    FAILED=1
  fi
fi

# ==================== Final Result ====================
echo ""
if [ $FAILED -eq 1 ]; then
  echo -e "${RED}‚ùå Pre-commit checks failed!${NC}"
  echo ""
  echo "Please fix the issues above before committing."
  echo "To bypass this hook (not recommended): git commit --no-verify"
  exit 1
else
  echo -e "${GREEN}‚úÖ All pre-commit checks passed!${NC}"
  exit 0
fi
